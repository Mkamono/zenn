---
title: "あなたのアプリにマルチリージョンは必要ないかもしれない"
emoji: "🌏"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["googlecloud"]
published: false
---

https://gemini.google.com/app/176e9195103a31af

https://gemini.google.com/app/176e9195103a31af

## はじめに

アプリケーションにおいて、可用性というものは非常に重要です。可用性を確保するにはインフラ上の単一障害点を回避し、冗長化を行うことが一般的です。今回はその可用性について、特にクラウドインフラにおけるマルチリージョン化の必要性について考察します。

## 可用性がそもそも必要か

高い可用性は、一般的に以下のようなサービスで必要となります

**ビジネスの直接的損失につながるもの**

- 機会損失につながるもの
  - ECサイト、ネット証券など。サービスが停止している間の売上や、取引の機会が失われるもの。特にセール時や限定商品の発売時などでは影響が甚大となります
- 顧客の信頼を失うもの
  - SNS、オンラインゲーム、ニュースサイトなど。ユーザーが｢使いたいときに使えない｣と感じると、サービスへの信頼がゆらぎ、利用を停止したり競合他社に流れる可能性があります
- 業務生産性を著しく低下させるもの
  - 社内の基幹システム、コミュニケーションツール、ファイル共有サービスなど。これらのサービスが停止すると、社員の業務が大幅に妨げられ、生産性が低下します

**社会インフラや人命に関わるもの**
- 生命や安全の維持に関わるもの
  - 医療機器の制御システム、緊急通報システム、交通管制システムなど。システムの不具合が直接的に人命に関わる可能性があります
- 社会基盤の維持に関わるもの
  - 電力供給システム、通信インフラ、金融システム、物流管理システムなど。これらのシステムが停止すると、広範囲にわたる社会的混乱や経済的損失を引き起こす可能性があります


**代替が効かない、または復旧コストが非常に高いもの**
- 代替手段が存在しないもの
  - 特定の行政手続きシステム、企業の特殊な生産ラインを制御するシステムなど。「そのシステムでしかできない」業務は、停止が許されません
- 手動での復旧が困難なもの
  - 大規模なデータ処理基盤や工場の自動化ラインなど。システム停止によって処理が中断されると、データの整合性を取ったり、生産ラインを正常な状態に戻したりするのに多大な時間とコストを要します

**契約や法的な制約があるもの**
- SLA（サービス品質保証契約）で稼働率を定めているもの
  - クラウドサービス（AWS, Azureなど）やデータセンターなど。顧客に対して「稼働率99.99%」のように契約で保証している場合、それを下回ると違約金の支払いなどが発生します。
- 法令や業界の規制で定められているもの
  - 金融業界や通信業界など、公共性の高い一部の業界では、監督官庁への報告義務や、安定稼働に関する厳しい規制が設けられています。

この中で、最も高い可用性を保っているのはおそらくAWS、Google Cloudなどのクラウドベンダでしょう。なぜなら彼らはインフラの専門的な知識と経験を持ち、膨大なリソースを投入しており、この基盤の上で重要なサービスを提供しているからです。

あなたのサービスが上記のどれにも該当しない場合、そこまで高い可用性を求める必要はないかもしれません。

可用性が必要ではないサービスには、社内利用で緊急性の低いシステムやリアルタイム性が不要なバッチ処理システム、個人・趣味で運営されるWebサイトなどがあります。

## どんな可用性が必要か

そして可用性は稼働率という一つの数字で表現されますが、その数字がすべてを表しているわけではありません。要素としては、主に以下の3つが挙げられます。

### 停止の質

システムの不具合は、完全にシステムが止まるものばかりではありません。部分的な機能の停止や、パフォーマンスの低下など、様々な形態があります。完全に機能が停止した1時間と、レイテンシが増加した1時間では、ユーザーへの影響は大きく異なります。

確実に処理が実行されることが重要であり、そのために多少の遅延が許容される場合、システムの一部が遅延することは大きな問題ではありません。

### 停止の頻度

システムの不具合は、頻繁に発生するものと、稀にしか発生しないものがあります。毎日数回発生する不具合であれば、ユーザーにとって大きなストレスとなりますが、年に一度発生する不具合であれば、ユーザーはそれほど気にしないかもしれません。

### 停止の時間

システムが停止する時間も重要です。数分間の停止であれば、ユーザーはそれほど影響を受けないかもしれませんが、数時間にわたる停止は大きな問題となります。業務においても数分間の停止であれば、手動での対応や、後でのリカバリが可能ですが、数時間にわたる停止は業務に大きな影響を与える可能性があります。

---

さて、あなたのサービスではどのような可用性が必要でしたか?

## どの程度の可用性が必要か

極論を言えば、どうしても、何があっても止めたくないサービスは存在するすべてのクラウドインフラを使い、すべてのリージョン、ゾーンで冗長化し、更に自社でもデータセンターを持ち、可能な限りの冗長化を行うべきです。しかしあなたのアプリケーションはそうはしないはずです。なぜですか?

それはさまざまなコストが高いという理由があるはずです。

- 費用コスト
  - 初期投資や、インフラにかかるコスト
  - 専門的な知識を持つ人材への人件費、採用コスト
- 時間的コスト
  - システムの設計、構築、運用にかかる時間
- 運用コスト
  - システムの監視、障害対応、アップデートにかかる時間と労力
  - システムの開発を遅らせてしまうもの
  - 複雑性の増大

あなたのアプリケーションがどのような戦略を取るかは、そのアプリケーションがどのような可用性を必要としているか、そしてその可用性を確保するためにどの程度のコストをかけることができるかによって決まります。そのコストとメリットのバランスを見ずに、マルチクラウドやマルチリージョンを選択することは、コストと複雑性を増大させるだけで、アプリケーションの可用性が向上するメリットを実感しにくくします。

また、あなたのアプリケーションが起こす障害(アプリケーションのバグ、設定ミス、人的ミス、セキュリティ)はクラウドインフラが起因となる障害に対して十分に小さいでしょうか? 企業が持つリソースには限りがあります。運用を複雑化させ、そのようなアプリケーションの障害への対応が遅れてしまっては可用性が低下し、本末転倒になってしまいます。

以降では、そのリスクがどの程度なのかを評価する材料を提供します。

## クラウド時代における可用性確保

話をわかりやすくするため、以下ではGoogle Cloudを例に説明します。

クラウド時代において、可用性の確保に対するハードルは大きく下がりました。例えば、Google Cloudが持っているように、東京と大阪にそれぞれ三拠点ずつデータセンターを持ち、それぞれのデータセンターに独立した電源、ネットワーク、冷却設備を備え、それぞれの環境のフェイルオーバーなどを整備することは、そのようなインフラを専門的に提供する企業以外ではではほぼ不可能です。

Google Cloudでは東京、大阪それぞれをリージョンとよび、その中にある物理的に分離されたデータセンターそれぞれをゾーンと読んでいます。

｢Google では、電力、冷却機能、ネットワーキングなどの物理インフラストラクチャの停止によって引き起こされる、連動障害のリスクを最小限に抑えるようにゾーンを設計しています。｣

https://cloud.google.com/compute/docs/regions-zones?hl=ja#choosing_a_region_and_zone

Google Cloudのサービスの多くはリージョン単位で展開されており、ゾーン単位での冗長化はすでに行われています。

しかしGoogleは｢リージョン全体が幅広く喪失した場合に耐えられる、障害復旧が可能なアプリケーションを作成するには｣マルチリージョン化を一つの選択肢として挙げています。

ではこの｢リージョン全体が幅広く喪失した場合｣とはどのような場合でしょうか？そのような状況はどの程度起こりうるのでしょうか？

https://cloud.google.com/docs/geography-and-regions?hl=ja

## Google Cloudサービスの障害を分析する

Google Cloudインフラがどの程度安定しているかを知るには、Google Cloud Status Dashboardを見るのが一番です。
https://status.cloud.google.com/summary

ここでは過去の障害の履歴を見ることができます。すべてのプロダクトについて調べるのはさすがに大変なので、代表的なプロダクトであるCompute Engine, Cloud Run, Cloud Storage, Cloud Load Balancingについてまとめます。

### Compute Engine

https://status.cloud.google.com/products/L3ggmi3Jy4xJmgodFA9K/history

| 日付 | 影響範囲(リージョン名、ゾーン名、その一部なのか全部なのか) | 影響(完全停止、遅延、一部停止など) | 影響時間 | 原因(災害、物理マシン不具合、人的ミス) |
| ---- | ---------------------------------------------------------- | ---------------------------------- | -------- | -------------------------------------- |


### Cloud Run

### Cloud Storage

### Cloud Load Balancing

### リージョン全体に影響を与えた障害

## 災害によってクラウドインフラが影響を受けた例

では大規模災害が起こったときはどうでしょうか？

*（具体的な災害事例を挙げ、どのゾーンが停止したか、リージョン全体には影響しなかったことを説明）*


## まとめ


----

メモ

説得のために何が必要か?

過去に災害がクラウドインフラにどの程度影響を与えたのか → 過去に災害によってのみリージョン全体に影響を与えた例はない。
https://gemini.google.com/app/224e8625c33333d0

リージョン全体に影響を与えた障害はどんなものか? → 設定ミスがほとんど。自然災害等は単一ゾーンの障害にとどまっている

過去に起こった障害の分析
対象(リージョン、ゾーン)
影響(完全停止、部分停止、パフォーマンス低下)
原因
復旧時間

極端な例を出す
マルチクラウド対応はどうですか?(多くの企業はやってないけど)
リージョン一つを失うリスクはもちろんありますが、リージョンが同時に止まるリスクもありますが? マルチクラウドだとそれは回避できますよ?
なぜやらないのか? 時間、費用コストが高い、リスクに見合っていないからだと思う

ではなぜマルチリージョンはどうですか?
時間、費用コストとリスクを天秤にかけないとだめじゃないですか?
リージョン一つが完全に止まるリスクを見ないとねぇ
そのリスクって、アプリケーションのセキュリティや、堅牢性、エラーの率より十分低くないですか?
そのリスクを回避するために、コストと運用の複雑さを増やす価値はありますか? その運用コストによってアプリケーションが脆弱になるリスクを増やすことはありませんか?

ではシングルゾーンでの運用は?
→実際に障害例がたくさんあるのでリージョナルなサービスにすることはわかりやすく意味がある
